# Интеграция с API "Деловые Линии" для расчета стоимости перевозки

## Описание

Интеграция с API компании "Деловые Линии" (Dellin) для автоматического расчета стоимости доставки оборудования в рамках методики расчета стоимости монтажных работ.

## Доступ к API

- **Сайт разработчика:** https://dev.dellin.ru/
- **Ключ приложения:** `433D67A0-A9D1-4293-A14C-83329023A30F`
- **Ключ идентифицирует приложение** и позволяет использовать публичный инструментарий API

## Основные методы API

### 1. Калькулятор стоимости и сроков перевозки

**URL:** `https://api.dellin.ru/v2/calculator.json`

**Метод:** POST

**Описание:** Позволяет рассчитать стоимость и сроки доставки груза между городами.

**Параметры запроса:**

```json
{
  "appkey": "433D67A0-A9D1-4293-A14C-83329023A30F",
  "delivery": {
    "deliveryType": {
      "type": "auto"
    },
    "arrival": {
      "variant": "address",
      "produceDate": "2025-12-01",
      "city": "7700000000000000000000000",
      "address": "ул. Ленина, д. 1"
    },
    "derival": {
      "variant": "terminal",
      "produceDate": "2025-11-25",
      "city": "5500000100000000000000000",
      "terminalID": "12345"
    }
  },
  "cargo": {
    "quantity": 1,
    "length": 100,
    "width": 50,
    "height": 50,
    "weight": 25,
    "totalVolume": 0.125,
    "totalWeight": 25
  }
}
```

**Важные параметры:**

- `appkey` — ключ приложения (обязательный)
- `delivery.arrival.city` — код города получения (код КЛАДР)
- `delivery.derival.city` — код города отправки (код КЛАДР)
- `cargo.weight` — вес груза в кг
- `cargo.length`, `cargo.width`, `cargo.height` — габариты в см
- `cargo.totalVolume` — объем в м³

**Получение скидок:**

Для учета персональных скидок необходимо передавать:
- `sessionID` — ID сессии личного кабинета (получается через метод авторизации)
- `requester.uid` — UID контрагента из списка доступных контрагентов
- `requester.role` — роль в перевозке

### 2. Поиск городов

**URL:** `https://api.dellin.ru/v2/cities.json`

**Метод:** POST

**Описание:** Поиск города по названию для получения кода КЛАДР.

**Параметры:**

```json
{
  "appkey": "433D67A0-A9D1-4293-A14C-83329023A30F",
  "q": "Екатеринбург"
}
```

### 3. Список терминалов в городе

**URL:** `https://api.dellin.ru/v2/terminals.json`

**Метод:** POST

**Описание:** Получение списка терминалов в указанном городе.

**Параметры:**

```json
{
  "appkey": "433D67A0-A9D1-4293-A14C-83329023A30F",
  "cityID": "7700000000000000000000000"
}
```

## Интеграция в методичку расчета

### Где используется

Интеграция с Dellin API используется в разделе **"10. Командировочные расходы"** и **"7. Нормирование затрат на закуп оборудования"** методички для расчета стоимости логистики.

### Алгоритм расчета логистики

1. **Определение параметров груза:**
   - Вес оборудования (кг)
   - Габариты (длина × ширина × высота в см)
   - Объем (м³)
   - Город отправки
   - Город получения

2. **Поиск кодов городов:**
   - Использовать метод поиска городов для получения кода КЛАДР
   - Кэшировать результаты для повторного использования

3. **Расчет стоимости доставки:**
   - Отправить запрос к калькулятору стоимости
   - Получить стоимость перевозки и сроки доставки
   - Учесть дополнительные услуги (страхование, упаковка и т.д.)

4. **Обработка результатов:**
   - Сохранить стоимость в расчетную таблицу
   - Указать источник: "API Dellin, дата расчета: [дата]"
   - Зафиксировать сроки доставки для планирования

### Пример использования

См. файл `example_calculation.py` в этой папке.

## Лимиты и ограничения

- **Лимит запросов:** по умолчанию для публичного API ограничено количество запросов в минуту
- **Увеличение лимита:** для увеличения лимита обратиться в техподдержку (https://helpdesk.dellin.ru/)
- **Ошибка 100005:** "Превышена допустимая частота запросов" — необходимо уменьшить частоту запросов или запросить увеличение лимита

## Тестовая среда

Тестовой среды для пользователей API нет. При оформлении тестовых заявок:

1. Создание черновиков (`inOrder: false`) — заявка сохраняется, но не передается в обработку
2. Создание предзаказов (`derival.variant: terminal`) — могут быть отменены в ЛК
3. Создание заявок на забор с будущей датой и пометкой "Тестовая заявка" в комментарии

## Техническая поддержка

- **Email:** api_support@dellin.ru
- **Портал поддержки:** https://helpdesk.dellin.ru/
- **Документация:** https://dev.dellin.ru/faq/api/

## Дополнительная информация

- **Регистрация:** https://dev.dellin.ru/registration/
- **Восстановление ключа:** https://dev.dellin.ru/restore/
- **Changelog:** https://dev.dellin.ru/changelog/

